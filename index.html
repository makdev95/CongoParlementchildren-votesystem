<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parlement des Enfants ‚Äî Voter</title>
<style>
  :root{--bg:#f4fbff;--card:#fff;--accent:#0277bd;--muted:#55607a}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#e9f7ff);color:#082033;display:flex;align-items:flex-start;justify-content:center;padding:18px}
  .container{width:100%;max-width:1100px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#066fb2,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(6,20,40,0.06)}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media (max-width:980px){.layout{grid-template-columns:1fr}}
  .role{margin-bottom:12px}
  .role h2{margin:8px 0;font-size:16px}
  .hlist{display:flex;gap:10px;overflow:auto;padding:8px}
  .card-candidate{min-width:150px;max-width:160px;background:linear-gradient(180deg,#fff,#10b70a);border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center;gap:8px;border:1px solid rgba(6,182,212,0.06)}
  .avatar{width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;font-size:36px}
  .cand-name{font-weight:800;text-align:center}
  .vote-btn{width:100%;padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .count{font-weight:900;margin-top:4px;display:none}
  .aside .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:12px}
  .btn{padding:9px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:2px solid #e6f7ff}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modal.open{display:flex}
  .modal-card{width:100%;max-width:760px;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 12px 36px rgba(8,24,44,0.08)}
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
  input[type=text], input[type=password], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef7ff;margin-top:6px}
  textarea{min-height:80px;resize:vertical}
  .voter-badge{display:inline-flex;gap:8px;align-items:center;padding:8px;background:#f1fbff;border-radius:10px;border:1px solid #e6f7ff;font-weight:700}
  .voter-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:380px;overflow:auto;padding-right:8px}
  .voter-item{padding:8px 10px;border-radius:12px;background:#fff;border:1px solid #e8f7ff;cursor:pointer;display:flex;gap:12px;align-items:center}
  .voter-avatar{width:40px;height:40px;border-radius:50%;flex:0 0 40px;overflow:hidden;display:inline-block}
  .muted{color:var(--muted);font-size:13px}
  /* hide public total */
  #totalWrapper{display:none}
  canvas#confetti{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:9999}
  .emoji-float{position:fixed;z-index:10000;pointer-events:none;font-size:28px;opacity:0;transform:translateY(0);transition:transform 1s,opacity 1s}
  /* envelope animation */
  .envelope{position:fixed;z-index:10001;pointer-events:none;width:60px;height:40px;background:#fff;border-radius:5px;box-shadow:0 6px 18px rgba(6,20,40,0.12);display:flex;align-items:center;justify-content:center;font-size:22px}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="container card">
  <header style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
    <div class="logo">PE</div>
    <div>
      <h1>Parlement des Enfants ‚Äî Vote 2025</h1>
      <div class="subtitle">Pr√©sident, Vice-Pr√©sident, Secr√©taire G√©n√©ral, Rapporteur, Secr√©taire charg√©.e de la Citoyennet√©, Charg√©¬∑e Relations</div>
    </div>
  </header>

  <section style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div id="selectedVoter" class="voter-badge">Aucun √©lecteur s√©lectionn√©</div>
    <div><button type="button" class="btn ghost" id="openVoterPicker">S√©lectionner √©lecteur</button></div>
  </section>

  <!-- Roles: updated to include relations -->
  <section class="role">
    <h2>Pr√©sident</h2>
    <div class="hlist" id="presList" aria-live="polite"></div>
  </section>

  <section class="role">
    <h2>Vice-Pr√©sident</h2>
    <div class="hlist" id="vpList" aria-live="polite"></div>
  </section>

  <section class="role">
    <h2>Secr√©taire G√©n√©ral</h2>
    <div class="hlist" id="secList" aria-live="polite"></div>
  </section>

  <section class="role">
    <h2>Rapporteur</h2>
    <div class="hlist" id="rapportList" aria-live="polite"></div>
  </section>

  <section class="role">
    <h2>Secr√©taire charg√©.e de la Citoyennet√©</h2>
    <div class="hlist" id="secretaireList" aria-live="polite"></div>
  </section>

  <section class="role">
    <h2>Charg√©¬∑e Relations avec le Parlement et autres organes</h2>
    <div class="hlist" id="relationsList" aria-live="polite"></div>
  </section>

  <div style="margin-top:10px" class="small">Conseils : s√©lectionne d'abord ton nom, puis appuie sur "Voter". Chaque √©lecteur peut voter une fois par r√¥le.</div>

  <hr style="margin:12px 0">

  <!-- total hidden for public -->
  <div id="totalWrapper">
    <strong>Total votes: <span id="total">0</span></strong> ‚Äî <span id="last">‚Äî</span>
  </div>

  <footer style="margin-top:12px">Design ‚Ä¢ Simple & real-time (Firestore)</footer>
</div>

<!-- voter picker (modal) -->
<div id="voterModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>S√©lectionner l'√©lecteur</h3>
    <div class="small">Tape sur le nom de l'√©lecteur.</div>
    <div id="voterList" class="voter-list"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button type="button" class="btn ghost" id="closeVoterPicker">Fermer</button>
    </div>
  </div>
</div>

<!-- Firebase (v8 compat) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ====== CONFIGURE FIREBASE ======
   Remplace avec ta config si n√©cessaire
*/
const firebaseConfig = {
  apiKey: "AIzaSyA_cdwwXT6DRcEm-555RxXETZ0Pwnv0bcQ",
  authDomain: "parlementvotesystemv1.firebaseapp.com",
  projectId: "parlementvotesystemv1",
  storageBucket: "parlementvotesystemv1.firebasestorage.app",
  messagingSenderId: "1014390957615",
  appId: "1:1014390957615:web:2ced35e18d4236451488da",
  measurementId: "G-J8VSKCE3M8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

/* ====== confetti & envelope animation ====== */
const canvas = document.getElementById('confetti');
const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
function resizeCanvas(){ if(!canvas) return; canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();
let confetti = [], confettiRunning = false;
function spawnConfettiAt(x,y){
  if(!ctx) return;
  const colors = ['#1c8a00','#f7d117','#d91f2a','#3b82f6','#a78bfa'];
  for(let i=0;i<28;i++){
    confetti.push({
      x: x + (Math.random()*40-20),
      y: y + (Math.random()*20-10),
      vx: (Math.random()-0.5)*6,
      vy: (Math.random()*-7)-2,
      life: 50 + Math.random()*40,
      size: 6 + Math.random()*6,
      color: colors[Math.floor(Math.random()*colors.length)]
    });
  }
  if(!confettiRunning) runConfetti();
}
function runConfetti(){
  if(!ctx) return;
  confettiRunning = true;
  (function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=confetti.length-1;i>=0;i--){
      const p = confetti[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.35; p.life--;
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, p.size, p.size);
      if(p.life <= 0 || p.y > canvas.height + 50) confetti.splice(i,1);
    }
    if(confetti.length > 0) requestAnimationFrame(loop);
    else confettiRunning = false;
  })();
}
function floatEmojiAt(x,y){
  const emojis = ['üéâ','‚ú®','üéà','üëè','ü•≥','üéä'];
  for(let i=0;i<6;i++){
    const el = document.createElement('div');
    el.className = 'emoji-float';
    el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    document.body.appendChild(el);
    const offsetX = (Math.random()*80 - 40);
    el.style.left = (x + offsetX) + 'px';
    el.style.top = (y + (Math.random()*40 - 10)) + 'px';
    requestAnimationFrame(()=> {
      el.style.opacity = '1';
      el.style.transform = 'translateY(-130px) scale(1.15)';
    });
    setTimeout(()=> {
      el.style.opacity = '0';
      try{ el.remove(); }catch(e){}
    }, 1400);
  }
}
function animateEnvelope(x,y){
  const env = document.createElement('div');
  env.className = 'envelope';
  env.textContent = '‚úâÔ∏è';
  document.body.appendChild(env);
  env.style.left = x + 'px';
  env.style.top = y + 'px';
  requestAnimationFrame(()=> { env.style.transform = 'translateY(-160px) scale(1)'; env.style.opacity='1'; });
  setTimeout(()=> { try{ env.remove(); }catch(e){} }, 1200);
}

/* ====== helpers ====== */
function uid(prefix){ return prefix + Math.random().toString(36).slice(2,9); }
function seededRandom(seed) {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < seed.length; i++) { h ^= seed.charCodeAt(i); h = Math.imul(h, 16777619); }
  return function(){ h += 0x6D2B79F5; let t = Math.imul(h ^ (h >>> 15), 1 | h); t ^= t + Math.imul(t ^ (t >>> 7), 61 | t); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; };
}
function childAvatarDataUrl(seed){
  const rnd = seededRandom(seed || String(Math.random()));
  const skinTones = ['#f6d6b8','#f0c8a0','#e6b38a','#d39a6c','#b58155'];
  const scarfColors = ['#08a200','#f7d117','#d91f2a','#3b82f6','#a78bfa'];
  const hairColors = ['#1f2937','#3b2f2f','#6b4423','#2f1b0b'];
  const bg = ['#ffffff','#fffaf0','#f7fff9','#f0f8ff'][Math.floor(rnd()*4)];
  const skin = skinTones[Math.floor(rnd()*skinTones.length)];
  const scarf = scarfColors[Math.floor(rnd()*scarfColors.length)];
  const hair = hairColors[Math.floor(rnd()*hairColors.length)];
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>
    <rect width='120' height='120' rx='20' fill='${bg}'/>
    <g transform='translate(10,10)'>
      <circle cx='50' cy='40' r='28' fill='${skin}'/>
      <circle cx='40' cy='36' r='3' fill='#0b2b3a'/>
      <circle cx='60' cy='36' r='3' fill='#0b2b3a'/>
      <path d='M40,48 Q50,56 60,48' stroke='#0b2b3a' stroke-width='2' fill='none' stroke-linecap='round'/>
      <path d='M22,32 Q42,18 78,28 Q62,18 38,22 Z' fill='${hair}' opacity='0.95'/>
      <g transform='translate(0,72)'>
        <rect x='0' y='0' width='120' height='18' fill='${scarf}'/>
        <rect x='0' y='0' width='40' height='18' fill='#f7d117'/>
        <rect x='80' y='0' width='40' height='18' fill='#08a200'/>
      </g>
    </g>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* ====== Firestore realtime + UI logic (includes new role 'relations') ====== */
const presList = document.getElementById('presList');
const vpList = document.getElementById('vpList');
const secList = document.getElementById('secList');
const rapportList = document.getElementById('rapportList');
const secretaireList = document.getElementById('secretaireList');
const relationsList = document.getElementById('relationsList');
const totalEl = document.getElementById('total');
const openVoterPicker = document.getElementById('openVoterPicker');
const voterModal = document.getElementById('voterModal');
const voterListEl = document.getElementById('voterList');
const closeVoterPicker = document.getElementById('closeVoterPicker');
const selectedVoterEl = document.getElementById('selectedVoter');

let selectedVoter = null;
let unsubCandidates = null;
let unsubVotes = null;

function normalizeRoleKey(raw){
  if(!raw) return 'pres';
  const r = String(raw).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(r.includes('vice')) return 'vice';
  if(r.includes('rapport')) return 'rapporteur';
  if(r.includes('citoy')) return 'secretaire'; // secr√©taire charg√©.e de la citoyennet√©
  if(r.includes('relations') || r.includes('parlement') || r.includes('organes')) return 'relations';
  if(r.includes('general') || r.includes('g') || (r.includes('secretaire') && r.includes('general'))) return 'sec';
  if(r.includes('pres')) return 'pres';
  return 'pres';
}

function startRealtime(){
  if(unsubCandidates) unsubCandidates();
  unsubCandidates = db.collection('candidates').orderBy('name').onSnapshot(snap => {
    const buckets = { pres: [], vice: [], sec: [], rapporteur: [], secretaire: [], relations: [] };
    snap.forEach(doc => {
      const d = Object.assign({ id: doc.id }, doc.data());
      const roleKey = normalizeRoleKey(d.role || '');
      if(buckets[roleKey]) buckets[roleKey].push(d);
      else buckets.pres.push(d);
    });
    renderCandidates(buckets);
  }, err => console.error('candidates listener', err));

  if(unsubVotes) unsubVotes();
  unsubVotes = db.collection('votes').orderBy('ts','desc').onSnapshot(snap => {
    if(totalEl) totalEl.textContent = snap.size;
  }, err => console.error('votes listener', err));
}

function renderCandidates(buckets){
  presList.innerHTML=''; vpList.innerHTML=''; secList.innerHTML=''; rapportList.innerHTML=''; secretaireList.innerHTML=''; relationsList.innerHTML='';
  (buckets.pres||[]).forEach(c => presList.appendChild(makeCard(c)));
  (buckets.vice||[]).forEach(c => vpList.appendChild(makeCard(c)));
  (buckets.sec||[]).forEach(c => secList.appendChild(makeCard(c)));
  (buckets.rapporteur||[]).forEach(c => rapportList.appendChild(makeCard(c)));
  (buckets.secretaire||[]).forEach(c => secretaireList.appendChild(makeCard(c)));
  (buckets.relations||[]).forEach(c => relationsList.appendChild(makeCard(c)));
}

function makeCard(candidate){
  const card = document.createElement('div'); card.className='card-candidate';
  const avatar = document.createElement('div'); avatar.className='avatar';
  // candidate image if stored, else emoji or fallback svg
  if(candidate.imageUrl) { const img = document.createElement('img'); img.src = candidate.imageUrl; img.width=84; img.height=84; img.alt=''; img.style.borderRadius='50%'; avatar.appendChild(img); }
  else if(candidate.emoji && candidate.emoji.trim()){ avatar.textContent = candidate.emoji; }
  else { const img = document.createElement('img'); img.src = childAvatarDataUrl(candidate.id || candidate.name || String(Math.random())); img.width = 84; img.height=84; img.style.borderRadius='50%'; avatar.appendChild(img); }

  const name = document.createElement('div'); name.className='cand-name'; name.textContent = candidate.name || '‚Äî';
  // replace icon with colored boxes (vert/jaune/rouge) for candidate marker
  const box = document.createElement('div'); box.style.width='40px'; box.style.height='12px'; box.style.borderRadius='6px'; box.style.marginBottom='4px';
  // pick color by candidate.id hash to vary but keep green/yellow/red group
  const h = Array.from((candidate.id||candidate.name||'').split('')).reduce((s,ch)=>s+ch.charCodeAt(0),0);
  const colors = ['#08a200','#f7d117','#d91f2a'];
  box.style.background = colors[h % 3];

  const btn = document.createElement('button'); btn.type='button'; btn.className='vote-btn'; btn.textContent='Voter';
  btn.addEventListener('click', (e)=> voteCandidate(candidate, e.currentTarget));
  const count = document.createElement('div'); count.className='count'; count.textContent = (candidate.votes||0);
  card.appendChild(avatar); card.appendChild(box); card.appendChild(name); card.appendChild(btn); card.appendChild(count);
  return card;
}

async function voteCandidate(candidate, btnElem){
  if(!selectedVoter){ alert("Veuillez d'abord s√©lectionner votre nom."); return; }
  const role = normalizeRoleKey(candidate.role || '');
  try{
    // check if voter already voted for this role
    const q = await db.collection('votes')
      .where('voterId','==', selectedVoter.id)
      .where('role','==', role)
      .limit(1)
      .get();
    if(!q.empty){ alert("Cet √©lecteur a d√©j√† vot√© pour ce r√¥le."); return; }

    const voteRef = db.collection('votes').doc();
    const candRef = db.collection('candidates').doc(candidate.id);

    await db.runTransaction(async (t)=>{
      t.set(voteRef, {
        voterId: selectedVoter.id,
        voterName: selectedVoter.name,
        candidateId: candidate.id,
        candidateName: candidate.name,
        role,
        ts: new Date().toISOString()
      });
      t.update(candRef, { votes: FieldValue.increment(1) });
    });

    // animations: confetti + emoji + envelope
    try{
      const rect = btnElem.getBoundingClientRect();
      const x = rect.left + rect.width/2;
      const y = rect.top + rect.height/2;
      spawnConfettiAt(x,y); floatEmojiAt(x,y); animateEnvelope(x,y);
    }catch(e){ console.warn('animation pos failed', e); }

    alert('Vote enregistr√© ‚Äî merci !');
  }catch(err){
    console.error('vote error', err);
    alert('Erreur lors du vote : ' + (err.message || err));
  }
}

/* ====== voter picker: list voters with generated child avatar ====== */
openVoterPicker.addEventListener('click', ()=> {
  voterModal.classList.add('open');
  voterModal.setAttribute('aria-hidden','false');
  loadVoters();
});
closeVoterPicker.addEventListener('click', ()=> {
  voterModal.classList.remove('open');
  voterModal.setAttribute('aria-hidden','true');
});

async function loadVoters(){
  if(!voterListEl) return;
  voterListEl.innerHTML = 'Chargement...';
  try{
    const snap = await db.collection('voters').orderBy('name').get();
    voterListEl.innerHTML = '';
    if(snap.empty){ const p = document.createElement('div'); p.className='muted'; p.textContent='Aucun √©lecteur disponible.'; voterListEl.appendChild(p); return; }
    snap.forEach(doc => {
      const v = Object.assign({ id: doc.id }, doc.data());
      const it = document.createElement('div'); it.className='voter-item';
      const imgWrap = document.createElement('div'); imgWrap.className='voter-avatar';
      const img = document.createElement('img');
      img.src = childAvatarDataUrl(v.id);
      img.width = 40; img.height = 40; img.style.display = 'block'; img.style.width='40px'; img.style.height='40px'; img.style.objectFit='cover';
      imgWrap.appendChild(img);
      it.appendChild(imgWrap);
      const s = document.createElement('strong'); s.textContent = v.name; it.appendChild(s);
      it.addEventListener('click', ()=> {
        selectedVoter = { id: v.id, name: v.name, emoji: v.emoji || '' };
        selectedVoterEl.textContent = (v.emoji?v.emoji+' ':'') + v.name;
        voterModal.classList.remove('open'); voterModal.setAttribute('aria-hidden','true');
      });
      voterListEl.appendChild(it);
    });
  }catch(err){
    console.error('loadVoters', err);
    voterListEl.innerHTML = '<div class="muted">Erreur chargement √©lecteurs</div>';
  }
}

/* ====== start listeners ====== */
startRealtime();

</script>
</body>
</html>
