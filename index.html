<!--
Parlement des Enfants ‚Äî Identified-voting (localStorage) ‚Äî Debugged

Fixes applied to resolve: "TypeError: Cannot read properties of undefined (reading 'push')"
- Always normalize the loaded state so arrays (pres, vice, sec, voters, voteRecords) and numeric fields exist.
- Consolidated save/load helpers to avoid accidental redefinition and ensure consistent behavior.
- Added defensive checks before pushing to arrays and when reading properties.
- Improved UX: when no voters exist, the voter picker shows a helpful message.

Save this file and open it in a browser.
-->

<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parlement des Enfants ‚Äî Vote (Identifi√©, local) ‚Äî Debugged</title>
<style>
  :root{--bg:#f4fbff;--card:#fff;--accent:#0277bd;--muted:#55607a;--radius:12px}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#e9f7ff);color:#082033;display:flex;align-items:flex-start;justify-content:center;padding:18px}
  .container{width:100%;max-width:1100px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#066fb2,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(6,20,40,0.06)}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media (max-width:980px){.layout{grid-template-columns:1fr}}

  .role{margin-bottom:12px}
  .role h2{margin:8px 0;font-size:16px}
  .hlist{display:flex;gap:10px;overflow:auto;padding:8px}
  .card-candidate{min-width:150px;max-width:160px;background:linear-gradient(180deg,#fff,#f7fdff);border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center;gap:8px;border:1px solid rgba(6,182,212,0.06)}
  .avatar{width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff}
  .cand-name{font-weight:800;text-align:center}
  .vote-btn{width:100%;padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .count{font-weight:900;margin-top:4px;display:none}

  .aside .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:12px}
  .btn{padding:9px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:2px solid #e6f7ff}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modal.open{display:flex}
  .modal-card{width:100%;max-width:760px;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 12px 36px rgba(8,24,44,0.08)}
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
  input[type=text], input[type=password], select{width:100%;padding:10px;border-radius:8px;border:1px solid #eef7ff;margin-top:6px}

  canvas#confetti{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:9999}
  .emoji{position:fixed;z-index:10000;pointer-events:none;font-size:26px;opacity:0;transform:translateY(0);transition:transform 1s,opacity 1s}

  .results-table{width:100%;border-collapse:collapse;margin-top:8px}
  .results-table th,.results-table td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
  .winner{background:linear-gradient(90deg,#fff9eb,#f0fff6);padding:10px;border-radius:8px;margin-bottom:8px}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}

  /* voter UI */
  .voter-badge{display:inline-flex;gap:8px;align-items:center;padding:8px;background:#f1fbff;border-radius:10px;border:1px solid #e6f7ff;font-weight:700}
  .voter-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .voter-item{padding:8px 10px;border-radius:12px;background:#fff;border:1px solid #e8f7ff;cursor:pointer;display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="container">
  <header>
    <div class="logo">PE</div>
    <div>
      <h1>Parlement des Enfants ‚Äî √âlection</h1>
      <div class="subtitle">Pr√©sident, Vice-Pr√©sident & Secr√©taire G√©n√©ral ‚Äî R√©publique du Congo</div>
    </div>
  </header>

  <div class="layout">
    <main class="card">
      <section style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div id="selectedVoter" class="voter-badge">Aucun √©lecteur s√©lectionn√©</div>
        <div><button class="btn ghost" id="openVoterPicker">S√©lectionner √©lecteur</button></div>
      </section>

      <section class="role">
        <h2>Pr√©sident</h2>
        <div class="hlist" id="presList" aria-live="polite"></div>
      </section>

      <section class="role">
        <h2>Vice-Pr√©sident</h2>
        <div class="hlist" id="vpList" aria-live="polite"></div>
      </section>

      <section class="role">
        <h2>Secr√©taire G√©n√©ral</h2>
        <div class="hlist" id="secList" aria-live="polite"></div>
      </section>

      <div style="margin-top:10px" class="small">Conseils: s√©lectionne d'abord ton nom, puis appuie sur le bouton "Voter" sous le candidat choisi. Chaque √©lecteur peut voter une fois par r√¥le.</div>
    </main>

    <aside class="card aside">
      <h3>Contr√¥les</h3>
      <div class="small" style="margin-top:8px">Total de votes: <strong id="total">0</strong></div>
      <div class="small" style="margin-top:6px">Dernier vote: <span id="last">‚Äî</span></div>

      <div class="controls">
        <button class="btn primary" id="btnAdmin">Admin</button>
        <button class="btn ghost" id="btnResults">Voir r√©sultats des votes</button>
      </div>

      <div style="margin-top:12px" class="small">Les r√©sultats sont prot√©g√©s par le code administrateur.</div>
    </aside>
  </div>

  <footer>Design: avatars enfants avec √©charpes aux couleurs du Congo ‚Ä¢ Simple & offline</footer>
</div>

<!-- Voter picker modal -->
<div id="voterModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>S√©lectionner l'√©lecteur</h3>
    <div class="small">Tap sur le nom de l'√©lecteur puis fermez la fen√™tre.</div>
    <div id="voterList" class="voter-list"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="voterClose">Fermer</button>
    </div>
  </div>
</div>

<!-- PIN modal (reusable) -->
<div id="pinModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>Code administrateur</h3>
    <input id="pinInput" type="password" placeholder="Entrer le code" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="pinCancel">Annuler</button>
      <button class="btn primary" id="pinOk">Valider</button>
    </div>
  </div>
</div>

<!-- Admin modal -->
<div id="adminModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>Administration ‚Äî G√©rer candidats & √©lecteurs</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label>Nom du candidat</label>
        <input type="text" id="adminName" placeholder="Ex: Jospin" />
        <label>Emoji (optionnel)</label>
        <input type="text" id="adminEmoji" placeholder="Ex: üßë‚Äçüéì" />
        <label>R√¥le</label>
        <select id="adminRole"><option value="pres">Pr√©sident</option><option value="vice">Vice-Pr√©sident</option><option value="sec">Secr√©taire G√©n√©ral</option></select>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="btn ghost" id="adminClose">Fermer</button>
          <button class="btn primary" id="adminAdd">Ajouter candidat</button>
        </div>
      </div>
      <div>
        <label>Nom de l'√©lecteur</label>
        <input type="text" id="adminVoterName" placeholder="Ex: Elenga" />
        <label>Emoji (optionnel)</label>
        <input type="text" id="adminVoterEmoji" placeholder="Ex: üòÄ" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="btn ghost" id="adminVoterClose">Fermer</button>
          <button class="btn primary" id="adminVoterAdd">Ajouter √©lecteur</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4>Liste des candidats</h4>
      <div id="adminList"></div>
      <h4 style="margin-top:10px">Liste des √©lecteurs</h4>
      <div id="adminVoterList"></div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="adminReset">R√©initialiser votes</button>
      <button class="btn ghost" id="adminExport">Exporter JSON</button>
    </div>
  </div>
</div>

<!-- Results modal -->
<div id="resultsModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h2>R√©sultats des votes</h2>
    <div id="winnerBanner" class="winner" style="display:none"></div>

    <h3>Pr√©sident</h3>
    <table class="results-table" id="presResults"><thead><tr><th>Candidat</th><th>Voix</th><th>√âlecteurs</th></tr></thead><tbody></tbody></table>

    <h3>Vice-Pr√©sident</h3>
    <table class="results-table" id="vpResults"><thead><tr><th>Candidat</th><th>Voix</th><th>√âlecteurs</th></tr></thead><tbody></tbody></table>

    <h3>Secr√©taire G√©n√©ral</h3>
    <table class="results-table" id="secResults"><thead><tr><th>Candidat</th><th>Voix</th><th>√âlecteurs</th></tr></thead><tbody></tbody></table>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="resultsClose">Fermer</button>
      <button class="btn ghost" id="resultsExport">Exporter JSON</button>
      <button class="btn ghost" id="resultsReset">R√©initialiser votes</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  const STORAGE_KEY = 'parlement_congo_v4';
  const ADMIN_PIN = '1234'; // change this before production

  // Canvas confetti
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();

  let confetti = [];
  function spawnConfetti(x,y){ const colors=['#1c8a00','#f7d117','#d91f2a','#3b82f6','#a78bfa']; for(let i=0;i<40;i++){ confetti.push({x,y,vx:(Math.random()-0.5)*6, vy:(Math.random()*-8)-2, life:60+Math.random()*40, size:6+Math.random()*8, color: colors[Math.floor(Math.random()*colors.length)]}); } if(!running) runConfetti(); }
  let running=false; function runConfetti(){ running=true; (function loop(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(let i=confetti.length-1;i>=0;i--){ const p=confetti[i]; p.x+=p.vx; p.y+=p.vy; p.vy += 0.35; p.life--; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); if(p.life<=0||p.y>canvas.height+50) confetti.splice(i,1); } if(confetti.length>0) requestAnimationFrame(loop); else running=false; })(); }

  function floatEmoji(x,y){ const emojis=['üéâ','‚ú®','üéà','üëè','ü•≥']; for(let i=0;i<6;i++){ const el=document.createElement('div'); el.className='emoji'; el.textContent = emojis[Math.floor(Math.random()*emojis.length)]; document.body.appendChild(el); el.style.left = (x + (Math.random()*80-40)) + 'px'; el.style.top = (y + (Math.random()*40-10)) + 'px'; requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(-120px) scale(1.2)'; }); setTimeout(()=>el.remove(),1400); } }

  // helpers: load/save and normalize
  function defaultState(){
    return {
      pres: [ {id:'p1', name:'Aminata', emoji:'', votes:0}, {id:'p2', name:'Jean', emoji:'', votes:0} ],
      vice: [ {id:'v1', name:'Maya', emoji:'', votes:0}, {id:'v2', name:'Lucas', emoji:'', votes:0} ],
      sec: [ {id:'s1', name:'Pierre', emoji:'', votes:0} ],
      voters: [],
      voteRecords: [],
      total: 0,
      last: null
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) { const d = defaultState(); saveState(d); return d; }
      const parsed = JSON.parse(raw);
      return normalizeState(parsed);
    }catch(e){ console.error('loadState error', e); const d = defaultState(); saveState(d); return d; }
  }

  function saveState(st){ try{ const normalized = normalizeState(st); localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized)); state = normalized; }catch(e){ console.error('saveState error', e); } }

  function normalizeState(s){
    const d = s && typeof s === 'object' ? s : {};
    d.pres = Array.isArray(d.pres) ? d.pres : [];
    d.vice = Array.isArray(d.vice) ? d.vice : [];
    d.sec = Array.isArray(d.sec) ? d.sec : [];
    d.voters = Array.isArray(d.voters) ? d.voters : [];
    d.voteRecords = Array.isArray(d.voteRecords) ? d.voteRecords : [];
    d.total = typeof d.total === 'number' ? d.total : 0;
    d.last = d.last || null;
    // ensure candidate objects have required props
    const ensureCand = c => ({ id: c && c.id ? c.id : ('c_'+Math.random().toString(36).slice(2,9)), name: c && c.name ? c.name : '‚Äî', emoji: c && c.emoji ? c.emoji : '', role: c && c.role ? c.role : 'pres', votes: typeof (c && c.votes) === 'number' ? c.votes : 0 });
    d.pres = d.pres.map(c => ensureCand(c));
    d.vice = d.vice.map(c => ensureCand(c));
    d.sec = d.sec.map(c => ensureCand(c));
    // ensure voters shape
    d.voters = d.voters.map(v => ({ id: v && v.id ? v.id : ('u_'+Math.random().toString(36).slice(2,9)), name: v && v.name ? v.name : '‚Äî', emoji: v && v.emoji ? v.emoji : '' }));
    // ensure voteRecords shape
    d.voteRecords = d.voteRecords.map(r => ({ id: r && r.id ? r.id : ('vr_'+Math.random().toString(36).slice(2,9)), voterId: r && r.voterId ? r.voterId : null, voterName: r && r.voterName ? r.voterName : '', candidateId: r && r.candidateId ? r.candidateId : null, candidateName: r && r.candidateName ? r.candidateName : '', role: r && r.role ? r.role : '', ts: r && r.ts ? r.ts : null }));

    // recompute counts from voteRecords to be safe
    recomputeCountsForState(d);
    return d;
  }

  function recomputeCountsForState(st){
    // zero out
    (st.pres||[]).forEach(c => c.votes = 0);
    (st.vice||[]).forEach(c => c.votes = 0);
    (st.sec||[]).forEach(c => c.votes = 0);
    (st.voteRecords||[]).forEach(vr => {
      const cid = vr.candidateId;
      if(!cid) return;
      const all = [...(st.pres||[]), ...(st.vice||[]), ...(st.sec||[])];
      const found = all.find(x => x.id === cid);
      if(found) found.votes = (found.votes||0) + 1;
    });
    st.total = (st.pres||[]).reduce((s,c)=>s+(c.votes||0),0) + (st.vice||[]).reduce((s,c)=>s+(c.votes||0),0) + (st.sec||[]).reduce((s,c)=>s+(c.votes||0),0);
  }

  // initial load
  let state = loadState();

  // DOM refs (ensure elements exist)
  const presList = document.getElementById('presList');
  const vpList = document.getElementById('vpList');
  const secList = document.getElementById('secList');
  const totalEl = document.getElementById('total');
  const lastEl = document.getElementById('last');
  const btnAdmin = document.getElementById('btnAdmin');
  const btnResults = document.getElementById('btnResults');

  const openVoterPicker = document.getElementById('openVoterPicker');
  const voterModal = document.getElementById('voterModal');
  const voterListEl = document.getElementById('voterList');
  const voterClose = document.getElementById('voterClose');
  const selectedVoterEl = document.getElementById('selectedVoter');

  const pinModal = document.getElementById('pinModal');
  const pinInput = document.getElementById('pinInput');
  const pinOk = document.getElementById('pinOk');
  const pinCancel = document.getElementById('pinCancel');

  const adminModal = document.getElementById('adminModal');
  const adminName = document.getElementById('adminName');
  const adminEmoji = document.getElementById('adminEmoji');
  const adminRole = document.getElementById('adminRole');
  const adminAdd = document.getElementById('adminAdd');
  const adminClose = document.getElementById('adminClose');
  const adminList = document.getElementById('adminList');
  const adminReset = document.getElementById('adminReset');
  const adminExport = document.getElementById('adminExport');
  const adminVoterName = document.getElementById('adminVoterName');
  const adminVoterEmoji = document.getElementById('adminVoterEmoji');
  const adminVoterAdd = document.getElementById('adminVoterAdd');
  const adminVoterClose = document.getElementById('adminVoterClose');
  const adminVoterList = document.getElementById('adminVoterList');

  const resultsModal = document.getElementById('resultsModal');
  const presResults = document.querySelector('#presResults tbody');
  const vpResults = document.querySelector('#vpResults tbody');
  const secResults = document.querySelector('#secResults tbody');
  const winnerBanner = document.getElementById('winnerBanner');
  const resultsClose = document.getElementById('resultsClose');
  const resultsExport = document.getElementById('resultsExport');
  const resultsReset = document.getElementById('resultsReset');

  // utility functions
  function uid(prefix){ return prefix + Math.random().toString(36).slice(2,9); }
  function avatarDataUrl(){ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><rect width='120' height='120' rx='60' fill='%23fff'/><g transform='translate(0,42)'><path d='M0,40 L120,40 L120,70 L0,70 Z' fill='%23eee'/><polygon points='0,40 120,0 120,20 0,60' fill='%2308a200'/><polygon points='0,60 120,20 120,40 0,80' fill='%23f7d117'/><polygon points='0,80 120,40 120,60 0,100' fill='%23d91f2a'/></g><circle cx='60' cy='44' r='28' fill='%23f6d6b8'/><circle cx='50' cy='42' r='3' fill='%230b2b3a'/><circle cx='70' cy='42' r='3' fill='%230b2b3a'/><path d='M50,52 Q60,60 70,52' stroke='%230b2b3a' stroke-width='2' fill='none' stroke-linecap='round'/></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); }

  // selected voter in-memory
  let selectedVoter = null;

  // render candidate cards (counts hidden on main screen)
  function makeCard(candidate){
    const card = document.createElement('div'); card.className='card-candidate';
    const avatar = document.createElement('div'); avatar.className='avatar';
    if(candidate.emoji && candidate.emoji.trim()){ avatar.textContent = candidate.emoji; }
    else { const img = document.createElement('img'); img.src = avatarDataUrl(); img.width = 84; img.height = 84; img.alt = 'avatar'; img.style.borderRadius='50%'; avatar.appendChild(img); }
    const name = document.createElement('div'); name.className='cand-name'; name.textContent = candidate.name || '‚Äî';
    const btn = document.createElement('button'); btn.className='vote-btn'; btn.textContent='Voter';
    const count = document.createElement('div'); count.className='count'; count.textContent = candidate.votes || 0;

    btn.addEventListener('click', function(){
      if(!selectedVoter){ alert('Veuillez d\'abord s√©lectionner votre nom (S√©lectionner √©lecteur).'); return; }
      // ensure voteRecords exists
      state.voteRecords = Array.isArray(state.voteRecords) ? state.voteRecords : [];
      // check if selectedVoter already voted for this role
      const already = state.voteRecords.find(v => v.voterId === selectedVoter.id && v.role === (candidate.role || 'pres'));
      if(already){ alert('Cet √©lecteur a d√©j√† vot√© pour ce r√¥le.'); return; }
      // prepare record
      const rec = { id: uid('vr_'), voterId: selectedVoter.id, voterName: selectedVoter.name, candidateId: candidate.id, candidateName: candidate.name, role: candidate.role || 'pres', ts: new Date().toISOString() };
      // push record safely
      state.voteRecords.push(rec);
      // increment candidate votes safely
      candidate.votes = (candidate.votes || 0) + 1;
      // update aggregates
      state.total = (state.total || 0) + 1;
      state.last = new Date().toLocaleString();
      saveState(state);
      totalEl.textContent = state.total; lastEl.textContent = state.last;
      // celebration
      const rect = btn.getBoundingClientRect(); const x = rect.left + rect.width/2; const y = rect.top + rect.height/2;
      spawnConfetti(x,y); floatEmoji(x,y);
      // re-render to update any hidden counts if admin opens results later
      renderAll();
    });

    card.appendChild(avatar); card.appendChild(name); card.appendChild(btn); card.appendChild(count);
    return card;
  }

  function renderAll(){
    // ensure arrays exist
    state = normalizeState(state);
    presList.innerHTML=''; vpList.innerHTML=''; secList.innerHTML='';
    (state.pres||[]).forEach(c=>presList.appendChild(makeCard(c)));
    (state.vice||[]).forEach(c=>vpList.appendChild(makeCard(c)));
    (state.sec||[]).forEach(c=>secList.appendChild(makeCard(c)));
    totalEl.textContent = state.total || 0; lastEl.textContent = state.last || '‚Äî';
    renderSelectedVoter();
  }

  // voter picker
  function renderVoterList(){
    voterListEl.innerHTML='';
    const arr = Array.isArray(state.voters) ? state.voters : [];
    if(arr.length === 0){ const p = document.createElement('div'); p.className='muted'; p.textContent = 'Aucun √©lecteur trouv√©. Ajoutez des √©lecteurs via Admin.'; voterListEl.appendChild(p); return; }
    arr.forEach(v=>{
      const it = document.createElement('div'); it.className='voter-item'; it.innerHTML = `${v.emoji?v.emoji+' ':''}<strong>${v.name}</strong>`;
      it.addEventListener('click', ()=>{ selectedVoter = v; renderSelectedVoter(); hideModal(voterModal); });
      voterListEl.appendChild(it);
    });
  }

  function renderSelectedVoter(){ if(selectedVoter) selectedVoterEl.innerHTML = `${selectedVoter.emoji?selectedVoter.emoji+' ':''}${selectedVoter.name}`; else selectedVoterEl.innerHTML = 'Aucun √©lecteur s√©lectionn√©'; }

  // show/hide modals
  function showModal(el){ if(!el) return; el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
  function hideModal(el){ if(!el) return; el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }

  // PIN flow with callback
  let pinCallback = null;
  function openPinFlow(callback){ pinCallback = callback; if(pinInput) pinInput.value=''; showModal(pinModal); if(pinInput) pinInput.focus(); }
  if(pinOk) pinOk.addEventListener('click', function(){ const v = pinInput && pinInput.value ? pinInput.value.trim() : ''; if(v === ADMIN_PIN){ hideModal(pinModal); if(typeof pinCallback === 'function') pinCallback(); pinCallback = null; } else { alert('PIN invalide'); } });
  if(pinCancel) pinCancel.addEventListener('click', function(){ hideModal(pinModal); pinCallback = null; });

  // admin actions
  if(btnAdmin) btnAdmin.addEventListener('click', function(){ openPinFlow(function(){ showModal(adminModal); renderAdminList(); }); });

  function renderAdminList(){
    adminList.innerHTML=''; adminVoterList.innerHTML='';
    function section(title, arr, role){ const h=document.createElement('div'); h.style.fontWeight='700'; h.style.marginTop='6px'; h.textContent = title; adminList.appendChild(h);
      (arr||[]).forEach(c=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.innerHTML = `<div>${c.emoji?c.emoji+' ':''}<strong>${c.name}</strong> <span style='color:#6b7280'>(votes: ${c.votes||0})</span></div>`; const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Supprimer'; del.addEventListener('click', function(){ if(confirm('Supprimer ce candidat ?')){ if(role==='pres') state.pres = (state.pres||[]).filter(x=>x.id!==c.id); else if(role==='vice') state.vice = (state.vice||[]).filter(x=>x.id!==c.id); else state.sec = (state.sec||[]).filter(x=>x.id!==c.id); // remove related voteRecords
              state.voteRecords = (state.voteRecords||[]).filter(vr=> vr.candidateId !== c.id);
              recomputeCountsForState(state); saveState(state); renderAll(); renderAdminList(); } }); row.appendChild(del); adminList.appendChild(row); }); }
    section('Pr√©sident', state.pres || [], 'pres'); section('Vice-Pr√©sident', state.vice || [], 'vice'); section('Secr√©taire G√©n√©ral', state.sec || [], 'sec');

    // voters
    const hv = document.createElement('div'); hv.style.fontWeight='700'; hv.style.marginTop='8px'; hv.textContent='√âlecteurs'; adminVoterList.appendChild(hv);
    (state.voters||[]).forEach(v=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.innerHTML = `<div>${v.emoji?v.emoji+' ':''}<strong>${v.name}</strong></div>`; const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Supprimer'; del.addEventListener('click', function(){ if(confirm('Supprimer cet √©lecteur ?')){ state.voters = (state.voters||[]).filter(x=>x.id!==v.id); // remove votes by this voter
              state.voteRecords = (state.voteRecords||[]).filter(vr=> vr.voterId !== v.id);
              recomputeCountsForState(state); saveState(state); renderAll(); renderAdminList(); } }); row.appendChild(del); adminVoterList.appendChild(row); });
  }

  if(adminAdd) adminAdd.addEventListener('click', function(){ const name = adminName && adminName.value ? adminName.value.trim() : ''; const emoji = adminEmoji && adminEmoji.value ? adminEmoji.value.trim() : ''; const role = adminRole && adminRole.value ? adminRole.value : 'pres'; if(!name){ alert('Entrez le nom du candidat'); return; } const id = uid(role==='pres'?'p':role==='vice'?'v':'s'); const entry = { id, name, emoji, role, votes: 0 }; if(role==='pres'){ state.pres = state.pres || []; state.pres.push(entry);} else if(role==='vice'){ state.vice = state.vice || []; state.vice.push(entry); } else { state.sec = state.sec || []; state.sec.push(entry); } saveState(state); if(adminName) adminName.value=''; if(adminEmoji) adminEmoji.value=''; renderAll(); renderAdminList(); });

  if(adminVoterAdd) adminVoterAdd.addEventListener('click', function(){ const name = adminVoterName && adminVoterName.value ? adminVoterName.value.trim() : ''; const emoji = adminVoterEmoji && adminVoterEmoji.value ? adminVoterEmoji.value.trim() : ''; if(!name){ alert('Entrez le nom de l\'√©lecteur'); return; } const id = uid('u'); const entry = { id, name, emoji }; state.voters = state.voters || []; state.voters.push(entry); saveState(state); if(adminVoterName) adminVoterName.value=''; if(adminVoterEmoji) adminVoterEmoji.value=''; renderAdminList(); });
  if(adminVoterClose) adminVoterClose.addEventListener('click', function(){ hideModal(adminModal); });
  if(adminClose) adminClose.addEventListener('click', function(){ hideModal(adminModal); });

  if(adminReset) adminReset.addEventListener('click', function(){ if(confirm('Remettre tous les compteurs √† z√©ro ?')){ (state.pres||[]).forEach(x=>x.votes=0); (state.vice||[]).forEach(x=>x.votes=0); (state.sec||[]).forEach(x=>x.votes=0); state.voteRecords = []; state.total = 0; state.last = null; saveState(state); renderAll(); renderAdminList(); alert('R√©initialis√©'); } });
  if(adminExport) adminExport.addEventListener('click', exportState);

  // voter picker wiring
  if(openVoterPicker) openVoterPicker.addEventListener('click', function(){ showModal(voterModal); renderVoterList(); });
  if(voterClose) voterClose.addEventListener('click', function(){ hideModal(voterModal); });

  // Results flow
  if(btnResults) btnResults.addEventListener('click', function(){ openPinFlow(function(){ openResultsModal(); }); });

  function openResultsModal(){ // populate tables with voters per candidate
    if(!presResults || !vpResults || !secResults) return;
    presResults.innerHTML=''; vpResults.innerHTML=''; secResults.innerHTML='';

    // build map candidateId -> [voterName,...]
    const map = {};
    (state.voteRecords||[]).forEach(vr => { if(!vr || !vr.candidateId) return; if(!map[vr.candidateId]) map[vr.candidateId]=[]; map[vr.candidateId].push(vr.voterName || '‚Äî'); });

    (state.pres||[]).forEach(c=>{ const tr=document.createElement('tr'); const voters = (map[c.id]||[]).join(', '); tr.innerHTML = `<td>${c.name}</td><td>${c.votes||0}</td><td>${voters}</td>`; presResults.appendChild(tr); });
    (state.vice||[]).forEach(c=>{ const tr=document.createElement('tr'); const voters = (map[c.id]||[]).join(', '); tr.innerHTML = `<td>${c.name}</td><td>${c.votes||0}</td><td>${voters}</td>`; vpResults.appendChild(tr); });
    (state.sec||[]).forEach(c=>{ const tr=document.createElement('tr'); const voters = (map[c.id]||[]).join(', '); tr.innerHTML = `<td>${c.name}</td><td>${c.votes||0}</td><td>${voters}</td>`; secResults.appendChild(tr); });

    // winners
    function getWinner(arr){ if(!arr||arr.length===0) return {names:[],max:0}; let max=-1; let winners=[]; arr.forEach(a=>{ const v = a.votes||0; if(v>max){ max=v; winners=[a.name]; } else if(v===max){ winners.push(a.name); } }); return {names:winners,max}; }
    const wp = getWinner(state.pres), wv = getWinner(state.vice), ws = getWinner(state.sec);
    let text = '';
    if(wp.names.length) text += `<strong>Pr√©sident:</strong> ${wp.names.join(', ')} (${wp.max} voix)`;
    if(wv.names.length) text += ` &nbsp; ‚Ä¢ &nbsp; <strong>Vice-Pr√©sident:</strong> ${wv.names.join(', ')} (${wv.max} voix)`;
    if(ws.names.length) text += ` &nbsp; ‚Ä¢ &nbsp; <strong>Secr√©taire G.:</strong> ${ws.names.join(', ')} (${ws.max} voix)`;
    if(winnerBanner) { winnerBanner.innerHTML = text; winnerBanner.style.display = text ? 'block' : 'none'; }

    showModal(resultsModal);
  }

  if(resultsClose) resultsClose.addEventListener('click', function(){ hideModal(resultsModal); });
  if(resultsExport) resultsExport.addEventListener('click', exportState);
  if(resultsReset) resultsReset.addEventListener('click', function(){ if(confirm('Remettre tous les compteurs √† z√©ro ?')){ (state.pres||[]).forEach(x=>x.votes=0); (state.vice||[]).forEach(x=>x.votes=0); (state.sec||[]).forEach(x=>x.votes=0); state.voteRecords = []; state.total = 0; state.last = null; saveState(state); renderAll(); hideModal(resultsModal); alert('R√©initialis√©'); } });

  function exportState(){ try{ const data = JSON.stringify(state,null,2); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'votes_parlement_with_voters.json'; a.click(); URL.revokeObjectURL(url); }catch(e){ console.error('exportState error', e); alert('Erreur export'); } }

  // helpers used by normalize
  function recomputeCounts(){ recomputeCountsForState(state); saveState(state); renderAll(); }

  // initial render
  renderAll();

})();
</script>
</body>
</html>
