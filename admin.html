<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parlement des Enfants ‚Äî Admin</title>
<style>
  :root{--bg:#f4fbff;--card:#fff;--accent:#0277bd;--muted:#55607a}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#e9f7ff);color:#082033;display:flex;align-items:flex-start;justify-content:center;padding:18px}
  .container{width:100%;max-width:1100px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(6,20,40,0.06)}
  h1{margin:0 0 12px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;margin-top:8px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eef7ff}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#eef9ff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .list{margin-top:12px;padding:8px;border-radius:8px;border:1px solid #f1f5f9;max-height:300px;overflow:auto}
  .row{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #f7fbff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee}
  small.role-label{display:block;color:#666;font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Administration ‚Äî G√©rer candidats & √©lecteurs</h1>

      <div class="grid">
        <div>
          <label>Nom du candidat</label>
          <input id="candName" type="text" placeholder="Ex: Aminata" />
          <label>Image (URL) ‚Äî optionnel</label>
          <input id="candImage" type="text" placeholder="https://..." />
          <label>Emoji (optionnel)</label>
          <input id="candEmoji" type="text" placeholder="üßë‚Äçüéì" />
          <label>R√¥le</label>
          <select id="candRole">
            <option value="pres">Pr√©sident</option>
            <option value="vice">Vice-Pr√©sident</option>
            <option value="sec">Secr√©taire G√©n√©ral</option>
            <option value="rapporteur">Rapporteur</option>
            <option value="secretaire">Secr√©taire charg√©.e de la Citoyennet√©</option>
            <option value="relations">Charg√©¬∑e Relations avec le Parlement et autres organes</option>
          </select>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
            <button id="addCandidate" class="btn primary">Ajouter candidat</button>
          </div>
        </div>

        <div>
          <label>Nom de l'√©lecteur</label>
          <input id="vName" type="text" placeholder="Ex: Koffi" />
          <label>Emoji (optionnel)</label>
          <input id="vEmoji" type="text" placeholder="üòÄ" />
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
            <button id="addVoter" class="btn primary">Ajouter √©lecteur</button>
          </div>

          <hr style="margin:12px 0" />
          <label>Ajouter des √©lecteurs en masse (une ligne = un nom)</label>
          <textarea id="bulkVoters" placeholder="Koffi"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
            <button id="bulkAdd" class="btn">Ajouter en masse</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3>Liste des candidats</h3>
        <div id="candidatesList" class="list"></div>
      </div>

      <div style="margin-top:12px">
        <h3>Votes (tableau en temps r√©el)</h3>
        <div style="margin-bottom:8px">
          <button id="refreshVotes" class="btn">Rafra√Æchir</button>
          <button id="exportVotersByCandidate" class="btn">Exporter JSON</button>
          <button id="resetVotes" class="btn">R√©initialiser votes</button>
        </div>
        <div id="votesTableWrap" class="list">
          <table id="votesTable"><thead><tr><th>Candidat</th><th>R√¥le</th><th>Nombre voix</th><th>√âlecteurs</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
/* Firebase config ‚Äî remplace si besoin */
const firebaseConfig = {
  apiKey: "AIzaSyA_cdwwXT6DRcEm-555RxXETZ0Pwnv0bcQ",
  authDomain: "parlementvotesystemv1.firebaseapp.com",
  projectId: "parlementvotesystemv1",
  storageBucket: "parlementvotesystemv1.firebasestorage.app",
  messagingSenderId: "1014390957615",
  appId: "1:1014390957615:web:2ced35e18d4236451488da"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

/* DOM refs */
const candName = document.getElementById('candName');
const candImage = document.getElementById('candImage');
const candEmoji = document.getElementById('candEmoji');
const candRole = document.getElementById('candRole');
const addCandidateBtn = document.getElementById('addCandidate');

const vName = document.getElementById('vName');
const vEmoji = document.getElementById('vEmoji');
const addVoterBtn = document.getElementById('addVoter');
const bulkVoters = document.getElementById('bulkVoters');
const bulkAddBtn = document.getElementById('bulkAdd');

const candidatesList = document.getElementById('candidatesList');
const votesTableBody = document.querySelector('#votesTable tbody');
const refreshVotesBtn = document.getElementById('refreshVotes');
const exportVotersByCandidateBtn = document.getElementById('exportVotersByCandidate');
const resetVotesBtn = document.getElementById('resetVotes');

/* Helpers */
function uid(prefix){ return prefix + Math.random().toString(36).slice(2,9); }
function splitLines(text){ return (''+(text||'')).split(/\r?\n/).map(l=>l.trim()).filter(Boolean); }

function roleLabel(key){
  switch((key||'').toString()){
    case 'pres': return 'Pr√©sident';
    case 'vice': return 'Vice-Pr√©sident';
    case 'sec': return 'Secr√©taire G√©n√©ral';
    case 'rapporteur': return 'Rapporteur';
    case 'secretaire': return 'Secr√©taire charg√©.e de la Citoyennet√©';
    case 'relations': return 'Charg√©¬∑e Relations avec le Parlement et autres organes';
    default: return key || '‚Äî';
  }
}

/* Add candidate */
addCandidateBtn.addEventListener('click', async ()=>{
  const name = candName.value && candName.value.trim();
  if(!name){ alert('Entrez le nom du candidat'); return; }
  const roleKey = candRole.value || 'pres';
  const data = {
    name,
    imageUrl: candImage.value && candImage.value.trim() || null,
    emoji: candEmoji.value && candEmoji.value.trim() || '',
    role: roleKey,
    roleLabel: roleLabel(roleKey),
    normalizedRole: (roleKey||'').toString().toLowerCase(),
    votes: 0,
    createdAt: new Date().toISOString()
  };
  try{
    await db.collection('candidates').add(data);
    candName.value=''; candImage.value=''; candEmoji.value='';
    loadCandidates();
  }catch(e){ console.error(e); alert('Erreur ajout candidat'); }
});

/* Add voter */
addVoterBtn.addEventListener('click', async ()=>{
  const name = vName.value && vName.value.trim();
  if(!name){ alert('Entrez le nom de l\'√©lecteur'); return; }
  try{
    await db.collection('voters').add({ name, emoji: vEmoji.value && vEmoji.value.trim() || '' });
    vName.value=''; vEmoji.value='';
    loadVoters();
  }catch(e){ console.error(e); alert('Erreur ajout √©lecteur'); }
});

/* Bulk add voters */
bulkAddBtn.addEventListener('click', async ()=>{
  const lines = splitLines(bulkVoters.value || '');
  if(lines.length===0){ alert('Collez au moins un nom'); return; }
  const batch = db.batch();
  const votersRef = db.collection('voters');
  lines.forEach(line=>{
    const parts = line.split(/[,|]/).map(p=>p.trim()).filter(Boolean);
    const name = parts[0];
    const emoji = parts[1] || '';
    if(name){ const doc = votersRef.doc(); batch.set(doc, { name, emoji }); }
  });
  try{ await batch.commit(); bulkVoters.value=''; loadVoters(); alert('Ajout√©'); }catch(e){ console.error(e); alert('Erreur'); }
});

/* Load candidates list for admin */
async function loadCandidates(){
  candidatesList.innerHTML = 'Chargement...';
  try{
    const snap = await db.collection('candidates').orderBy('role').get();
    candidatesList.innerHTML = '';
    if(snap.empty){ candidatesList.textContent = 'Aucun candidat.'; return; }
    snap.forEach(doc=>{
      const c = { id: doc.id, ...doc.data() };
      const row = document.createElement('div'); row.className='row';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${c.name}</strong><small class="role-label">${roleLabel(c.role)}</small>`;
      const right = document.createElement('div');
      const del = document.createElement('button'); del.className='btn'; del.textContent='Supprimer';
      del.addEventListener('click', async () => {
        if(!confirm('Supprimer ce candidat ?')) return;
        try{
          await db.collection('candidates').doc(c.id).delete();
          // remove related votes
          const vsnap = await db.collection('votes').where('candidateId','==', c.id).get();
          const batch = db.batch();
          vsnap.forEach(vd => batch.delete(db.collection('votes').doc(vd.id)));
          await batch.commit();
          loadCandidates(); loadVotesTable();
        }catch(e){ console.error(e); alert('Erreur suppression'); }
      });
      right.appendChild(del);
      row.appendChild(left); row.appendChild(right);
      candidatesList.appendChild(row);
    });
  }catch(e){ console.error(e); candidatesList.textContent = 'Erreur chargement candidats'; }
}

/* Load voters list (not shown but kept) */
async function loadVoters(){ /* optional: used after adds */ }

/* Votes table real-time (and initial) */
let votesUnsub = null;
function listenVotes(){
  if(votesUnsub) votesUnsub();
  votesUnsub = db.collection('votes').onSnapshot(snap=>{
    // Build map candidateId -> [voterName,...]
    const map = {};
    const votes = [];
    snap.forEach(doc => votes.push({ id: doc.id, ...doc.data() }));
    votes.forEach(v=>{
      if(!v.candidateId) return;
      map[v.candidateId] = map[v.candidateId] || [];
      map[v.candidateId].push(v.voterName || '‚Äî');
    });
    renderVotesTable(map);
  }, err => console.error('votes listener', err));
}

async function renderVotesTable(map){
  votesTableBody.innerHTML = '';
  try{
    const snap = await db.collection('candidates').orderBy('role').get();
    if(snap.empty){ votesTableBody.innerHTML = '<tr><td colspan="4">Aucun candidat</td></tr>'; return; }
    snap.forEach(doc=>{
      const c = { id: doc.id, ...doc.data() };
      const voters = map[c.id] || [];
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = c.name || '‚Äî';
      const tdRole = document.createElement('td'); tdRole.textContent = roleLabel(c.role || c.normalizedRole || '‚Äî');
      const tdCount = document.createElement('td'); tdCount.textContent = voters.length;
      const tdList = document.createElement('td'); tdList.textContent = voters.join(', ');
      tr.appendChild(tdName); tr.appendChild(tdRole); tr.appendChild(tdCount); tr.appendChild(tdList);
      votesTableBody.appendChild(tr);
    });
  }catch(e){ console.error(e); votesTableBody.innerHTML = '<tr><td colspan="4">Erreur</td></tr>'; }
}

/* Export voters by candidate */
exportVotersByCandidateBtn.addEventListener('click', async ()=>{
  try{
    const snapC = await db.collection('candidates').get();
    const snapV = await db.collection('votes').get();
    const map = {};
    snapV.forEach(d => {
      const v = d.data();
      map[v.candidateId] = map[v.candidateId] || [];
      map[v.candidateId].push({ voterId: v.voterId, voterName: v.voterName, ts: v.ts, role: v.role });
    });
    const rows = [];
    snapC.forEach(d => {
      const c = { id: d.id, ...d.data() };
      rows.push({ candidateId: c.id, candidateName: c.name, roleKey: c.role, roleLabel: roleLabel(c.role), voters: map[c.id] || [] });
    });
    const blob = new Blob([JSON.stringify({ generatedAt: new Date().toISOString(), rows }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'voters_by_candidate.json'; a.click(); URL.revokeObjectURL(url);
  }catch(e){ console.error(e); alert('Erreur export'); }
});

/* Reset votes (admin) */
resetVotesBtn.addEventListener('click', async ()=>{
  if(!confirm('R√©initialiser tous les votes ?')) return;
  try{
    // delete votes collection documents (batched)
    const snap = await db.collection('votes').get();
    const batchSize = 400;
    let batch = db.batch(), count=0;
    snap.forEach(doc => { batch.delete(db.collection('votes').doc(doc.id)); count++; if(count % batchSize === 0){ batch.commit(); batch = db.batch(); } });
    await batch.commit();

    // reset candidate vote counters to 0
    const csnap = await db.collection('candidates').get();
    const b2 = db.batch();
    csnap.forEach(doc => b2.update(db.collection('candidates').doc(doc.id), { votes: 0 } ));
    await b2.commit();

    alert('Votes r√©initialis√©s');
  }catch(e){ console.error(e); alert('Erreur r√©initialisation'); }
});

/* Refresh button */
refreshVotesBtn.addEventListener('click', ()=> { renderVotesTable({}); });

/* Init */
loadCandidates();
listenVotes();

</script>
</body>
</html>
