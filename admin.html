<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parlement des Enfants ‚Äî Admin (Podium & Dropdown per role)</title>
<style>
  :root{--bg:#f4fbff;--card:#fff;--accent:#0277bd;--muted:#55607a}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#e9f7ff);color:#082033;display:flex;align-items:flex-start;justify-content:center;padding:18px}
  .container{width:100%;max-width:1200px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#066fb2,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(6,20,40,0.06)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
  input[type=text], input[type=password], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef7ff;margin-top:6px}
  input[type=file]{margin-top:6px}
  textarea{min-height:90px;resize:vertical}
  .btn{padding:9px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:2px solid #e6f7ff}
  .list{margin-top:8px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5f9}
  .small{font-size:13px;color:var(--muted)}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modal-card{width:100%;max-width:520px;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 12px 36px rgba(8,24,44,0.08)}
  .pin-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:9999}
  .pin-box{background:#fff;padding:20px;border-radius:12px;min-width:320px;text-align:center}
  .muted{color:var(--muted)}
  .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .stat{background:#f8fbff;padding:10px;border-radius:8px;border:1px solid #eaf7ff}
  .results-table{width:100%;border-collapse:collapse;margin-top:8px}
  .results-table th,.results-table td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}

  /* podium */
  .podium-wrap{margin-top:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#f7fffb);box-shadow:0 8px 20px rgba(6,20,40,0.04)}
  .role-block{margin-top:12px}
  .podium{display:flex;align-items:flex-end;justify-content:center;gap:14px;padding-top:12px}
  .pod{width:140px;text-align:center;border-radius:10px;padding:8px}
  .pod .avatar{width:84px;height:84px;border-radius:50%;margin:0 auto 6px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .pod .name{font-weight:800}
  .pod .percent{font-weight:700}
  .pod-1{background:linear-gradient(90deg,#e6ffed,#f0fff6);border:3px solid #0f9d58;padding-bottom:8px}
  .pod-2{background:linear-gradient(90deg,#fffce6,#fff9f0);border:3px solid #f4b400;padding-bottom:8px}
  .pod-3{background:linear-gradient(90deg,#fff1f0,#fff7f7);border:3px solid #db4437;padding-bottom:8px}
  .podion-ribbon{font-size:12px;margin-bottom:6px}
  .avatar img{width:100%;height:100%;object-fit:cover}

</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">PE</div>
    <div>
      <h1>Admin ‚Äî Parlement des Enfants</h1>
      <div class="subtitle">G√©rer candidats, √©lecteurs et r√©sultats (Firestore)</div>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h3>Ajouter un candidat</h3>
      <label>Nom</label>
      <input id="candName" type="text" placeholder="Ex: Aminata" />
      <label>Emoji (optionnel)</label>
      <input id="candEmoji" type="text" placeholder="Ex: üßë‚Äçüéì" />
      <label>R√¥le</label>
      <select id="candRole">
        <option value="pres">Pr√©sident</option>
        <option value="vice">Vice-Pr√©sident</option>
        <option value="sec">Secr√©taire G√©n√©ral</option>
        <option value="rapporteur">Rapporteur</option>
        <option value="secretaire">Secr√©taire</option>
      </select>
      <label>Photo (optionnel)</label>
      <input id="candPhoto" type="file" accept="image/*" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="addCandidate" class="btn primary">Ajouter candidat</button>
      </div>

      <hr />

      <h3>Ajouter un √©lecteur</h3>
      <label>Nom</label>
      <input id="voterName" type="text" placeholder="Ex: Koffi" />
      <label>Emoji (optionnel)</label>
      <input id="voterEmoji" type="text" placeholder="Ex: üòÄ" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="addVoter" class="btn primary">Ajouter √©lecteur</button>
      </div>

      <hr />

      <h3>Ajouter plusieurs √©lecteurs (une ligne = un nom)</h3>
      <textarea id="bulkVoters" placeholder="Koffi
Amina
..."></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="bulkAddVoters" class="btn ghost">Ajouter en masse</button>
      </div>

      <hr />

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="resetVotes" class="btn ghost">R√©initialiser votes</button>
        <button id="exportJson" class="btn ghost">Exporter JSON</button>
      </div>

      <div class="small" style="margin-top:10px">Actions prot√©g√©es par PIN (cette page te demande le PIN au chargement).</div>
    </div>

    <aside class="card">
      <h3>Tableau de bord</h3>
      <div class="stats">
        <div class="stat"><strong id="statCandidates">0</strong><div class="small">Candidats</div></div>
        <div class="stat"><strong id="statVoters">0</strong><div class="small">√âlecteurs</div></div>
        <div class="stat"><strong id="statVotes">0</strong><div class="small">Votes</div></div>
      </div>

      <h4 style="margin-top:12px">Liste candidats (s√©lectionnable)</h4>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <select id="candidatesDropdown" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef7ff"></select>
        <button id="deleteSelectedCandidate" class="btn ghost" title="Supprimer le candidat s√©lectionn√©">Suppr</button>
      </div>

      <h4 style="margin-top:12px">Liste √©lecteurs (s√©lectionnable)</h4>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <select id="votersDropdown" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef7ff"></select>
        <button id="deleteSelectedVoter" class="btn ghost" title="Supprimer l'√©lecteur s√©lectionn√©">Suppr</button>
      </div>

      <h4 style="margin-top:14px">Podium ‚Äî par r√¥le</h4>
      <div id="podiumContainer" class="podium-wrap"></div>

    </aside>
  </div>
</div>

<!-- PIN overlay shown until admin authenticates -->
<div id="pinOverlay" class="pin-overlay">
  <div class="pin-box">
    <h3>Code administrateur requis</h3>
    <input id="pinInput" type="password" placeholder="Entrer le code admin" style="padding:8px;border-radius:8px;border:1px solid #eee;width:100%;box-sizing:border-box;margin-top:10px" />
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="pinCancel" class="btn ghost">Fermer</button>
      <button id="pinSubmit" class="btn primary">Valider</button>
    </div>
    <div class="small" style="margin-top:8px">Par d√©faut le PIN est <code>1234</code> ‚Äî change-le dans le code avant d√©ploiement.</div>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  'use strict';
  // === CONFIGURE FIREBASE (remplace par ta config) ===
  const firebaseConfig = {
    apiKey: "AIzaSyA_cdwwXT6DRcEm-555RxXETZ0Pwnv0bcQ",
    authDomain: "parlementvotesystemv1.firebaseapp.com",
    projectId: "parlementvotesystemv1",
    storageBucket: "parlementvotesystemv1.firebasestorage.app",
    messagingSenderId: "1014390957615",
    appId: "1:1014390957615:web:2ced35e18d4236451488da",
    measurementId: "G-J8VSKCE3M8"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const ADMIN_PIN = '1234';
  const ROLES = ['pres','vice','sec','rapporteur','secretaire'];
  const ROLE_LABEL = { pres:'Pr√©sident', vice:'Vice-Pr√©sident', sec:'Secr√©taire G√©n√©ral', rapporteur:'Rapporteur', secretaire:'Secr√©taire' };

  // DOM refs
  const pinOverlay = document.getElementById('pinOverlay');
  const pinInput = document.getElementById('pinInput');
  const pinSubmit = document.getElementById('pinSubmit');
  const pinCancel = document.getElementById('pinCancel');

  const candName = document.getElementById('candName');
  const candEmoji = document.getElementById('candEmoji');
  const candRole = document.getElementById('candRole');
  const candPhoto = document.getElementById('candPhoto');
  const addCandidate = document.getElementById('addCandidate');

  const voterName = document.getElementById('voterName');
  const voterEmoji = document.getElementById('voterEmoji');
  const addVoter = document.getElementById('addVoter');

  const bulkVoters = document.getElementById('bulkVoters');
  const bulkAddVoters = document.getElementById('bulkAddVoters');

  const resetVotes = document.getElementById('resetVotes');
  const exportJson = document.getElementById('exportJson');

  const statCandidates = document.getElementById('statCandidates');
  const statVoters = document.getElementById('statVoters');
  const statVotes = document.getElementById('statVotes');

  const candidatesDropdown = document.getElementById('candidatesDropdown');
  const deleteSelectedCandidate = document.getElementById('deleteSelectedCandidate');
  const votersDropdown = document.getElementById('votersDropdown');
  const deleteSelectedVoter = document.getElementById('deleteSelectedVoter');

  const podiumContainer = document.getElementById('podiumContainer');

  // helpers
  function uid(prefix){ return prefix + Math.random().toString(36).slice(2,9); }
function splitLines(text){ return (''+(text||'')).split(/\r?\n/).map(l=>l.trim()).filter(Boolean); }

  function lockAdmin(){ pinOverlay.style.display = 'flex'; }
  function unlockAdmin(){ pinOverlay.style.display = 'none'; startRealtimeListeners(); }

  pinCancel.addEventListener('click', function(){ alert('Acc√®s admin annul√©'); });
  pinSubmit.addEventListener('click', function(){ const val = (pinInput && pinInput.value||'').trim(); if(val === ADMIN_PIN){ unlockAdmin(); } else { alert('PIN invalide'); } });

  // firestore ops
  async function addCandidateToFirestore(name, emoji, role, photoDataUrl){
    await db.collection('candidates').add({ name, emoji: emoji||'', role: role||'pres', photo: photoDataUrl||'', createdAt: new Date().toISOString() });
  }
  async function addVoterToFirestore(name, emoji){ await db.collection('voters').add({ name, emoji: emoji||'', createdAt: new Date().toISOString() }); }

  addCandidate.addEventListener('click', async ()=>{
    const name = (candName.value||'').trim(); if(!name){ alert('Entrez le nom du candidat'); return; }
    const emoji = candEmoji.value||''; const role = candRole.value||'pres';
    // handle optional photo
    if(candPhoto && candPhoto.files && candPhoto.files[0]){
      const f = candPhoto.files[0]; const reader = new FileReader(); reader.onload = async function(e){ const dataUrl = e.target.result; try{ await addCandidateToFirestore(name, emoji, role, dataUrl); candName.value=''; candEmoji.value=''; candPhoto.value=''; alert('Candidat ajout√©'); }catch(er){ console.error(er); alert('Erreur ajout candidat'); } };
      reader.readAsDataURL(f);
    } else {
      try{ await addCandidateToFirestore(name, emoji, role, ''); candName.value=''; candEmoji.value=''; alert('Candidat ajout√©'); }catch(e){ console.error(e); alert('Erreur ajout candidat'); }
    }
  });

  addVoter.addEventListener('click', async ()=>{
    const name = (voterName.value||'').trim(); if(!name){ alert('Entrez le nom de l\'√©lecteur'); return; }
    try{ await addVoterToFirestore(name, (voterEmoji.value||'')); voterName.value=''; voterEmoji.value=''; alert('√âlecteur ajout√©'); }catch(e){ console.error(e); alert('Erreur ajout √©lecteur'); }
  });

  bulkAddVoters.addEventListener('click', async ()=>{
    const names = splitLines(bulkVoters.value||''); if(!names.length){ alert('Collez au moins un nom'); return; }
    try{
      const batch = db.batch();
      names.forEach(n=>{ const ref = db.collection('voters').doc(); batch.set(ref, { name: n, emoji: '', createdAt: new Date().toISOString() }); });
      await batch.commit(); bulkVoters.value=''; alert(names.length+' √©lecteur(s) ajout√©(s)');
    }catch(e){ console.error(e); alert('Erreur ajout en masse'); }
  });

  exportJson.addEventListener('click', async ()=>{
    try{
      const out={candidates:[],voters:[],votes:[]};
      const [cands,vots,vtrs] = await Promise.all([db.collection('candidates').get(), db.collection('votes').get(), db.collection('voters').get()]);
      cands.forEach(d=>out.candidates.push(Object.assign({id:d.id}, d.data())));
      vtrs.forEach(d=>out.voters.push(Object.assign({id:d.id}, d.data())));
      vots.forEach(d=>out.votes.push(Object.assign({id:d.id}, d.data())));
      const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='parlement_export.json'; a.click(); URL.revokeObjectURL(url);
    }catch(e){ console.error(e); alert('Erreur export'); }
  });

  resetVotes.addEventListener('click', async ()=>{
    if(!confirm('Remettre tous les compteurs √† z√©ro ?')) return;
    try{
      // delete votes in batches
      const delBatch = async ()=>{
        const snap = await db.collection('votes').limit(300).get(); if(snap.empty) return; const batch = db.batch(); snap.forEach(d=>batch.delete(d.ref)); await batch.commit(); await delBatch(); };
      await delBatch();
      // reset candidate votes
      const cands = await db.collection('candidates').get(); const batch = db.batch(); cands.forEach(d=>batch.update(d.ref, { votes: 0 })); await batch.commit(); alert('R√©initialis√©');
    }catch(e){ console.error(e); alert('Erreur r√©initialisation'); }
  });

  async function deleteCandidate(cid){ if(!confirm('Supprimer ce candidat et ses votes ?')) return; try{ const delByCandidate = async ()=>{ const snap = await db.collection('votes').where('candidateId','==',cid).limit(300).get(); if(snap.empty) return; const batch = db.batch(); snap.forEach(d=>batch.delete(d.ref)); await batch.commit(); await delByCandidate(); }; await delByCandidate(); await db.collection('candidates').doc(cid).delete(); alert('Candidat supprim√©'); }catch(e){ console.error(e); alert('Erreur suppression candidat'); } }

  async function deleteVoter(vid){ if(!confirm('Supprimer cet √©lecteur et ses votes ?')) return; try{ const delByVoter = async ()=>{ const snap = await db.collection('votes').where('voterId','==',vid).limit(300).get(); if(snap.empty) return; const batch = db.batch(); snap.forEach(d=>batch.delete(d.ref)); await batch.commit(); await delByVoter(); }; await delByVoter(); await db.collection('voters').doc(vid).delete(); alert('√âlecteur supprim√©'); }catch(e){ console.error(e); alert('Erreur suppression √©lecteur'); } }

  deleteSelectedVoter.addEventListener('click', async ()=>{ const opt = votersDropdown.options[votersDropdown.selectedIndex]; if(!opt){ alert('Aucun √©lecteur s√©lectionn√©'); return; } const id = opt.value; await deleteVoter(id); });
  deleteSelectedCandidate.addEventListener('click', async ()=>{ const opt = candidatesDropdown.options[candidatesDropdown.selectedIndex]; if(!opt){ alert('Aucun candidat s√©lectionn√©'); return; } const id = opt.value; await deleteCandidate(id); });

  // podium helpers ‚Äî use candidate.photo if present else generate child avatar
  function childAvatarDataUrl(seed){ const colors = ['#704214','#4b2e83','#2b4f77','#5a3c2b']; const c = colors[Math.abs(hashCode(seed||'a')) % colors.length]; const svg = "<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>"+
      "<rect width='120' height='120' rx='60' fill='%23fff'/>"+
      "<g transform='translate(0,42)'>"+
        "<path d='M0,40 L120,40 L120,70 L0,70 Z' fill='%23eee'/>"+
        "<polygon points='0,40 120,0 120,20 0,60' fill='%2308a200'/>"+
        "<polygon points='0,60 120,20 120,40 0,80' fill='%23f7d117'/>"+
        "<polygon points='0,80 120,40 120,60 0,100' fill='%23d91f2a'/>"+
      "</g>"+
      "<circle cx='60' cy='44' r='28' fill='%23f6d6b8'/>"+
      "<path d='M42,44 Q60,30 78,44' fill='"+c+"'/>"+
      "<circle cx='50' cy='48' r='3' fill='%230b2b3a'/>"+
      "<circle cx='70' cy='48' r='3' fill='%230b2b3a'/>"+
      "<path d='M50,58 Q60,66 70,58' stroke='%230b2b3a' stroke-width='2' fill='none' stroke-linecap='round'/>"+
      "</svg>";
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }
  function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h = ((h<<5)-h) + str.charCodeAt(i); h |= 0; } return h; }

  function makePodiumHtmlForRole(role){
    const id = 'pod_'+role;
    return `
      <div class="role-block" id="${id}">
        <strong>${ROLE_LABEL[role]||role}</strong>
        <div class="podium" data-role="${role}">
          <div class="pod pod-2" data-pos="2">
            <div class="podion-ribbon">2</div>
            <div class="avatar" data-avatar="${role}_2"></div>
            <div class="name" data-name="${role}_2">‚Äî</div>
            <div class="percent" data-pct="${role}_2">0%</div>
          </div>
          <div class="pod pod-1" data-pos="1">
            <div class="podion-ribbon">1</div>
            <div class="avatar" data-avatar="${role}_1"></div>
            <div class="name" data-name="${role}_1">‚Äî</div>
            <div class="percent" data-pct="${role}_1">0%</div>
          </div>
          <div class="pod pod-3" data-pos="3">
            <div class="podion-ribbon">3</div>
            <div class="avatar" data-avatar="${role}_3"></div>
            <div class="name" data-name="${role}_3">‚Äî</div>
            <div class="percent" data-pct="${role}_3">0%</div>
          </div>
        </div>
      </div>
    `;
  }

  function updatePodiumForRole(role, candidates){
    const sorted = (candidates||[]).slice().sort((a,b)=> (b.votes||0) - (a.votes||0));
    const total = (candidates||[]).reduce((s,c)=>s+(c.votes||0),0) || 0;
    const top1 = sorted[0]||null, top2 = sorted[1]||null, top3 = sorted[2]||null;
    const set = (slot, cand)=>{
      const avatarEl = podiumContainer.querySelector('[data-avatar="'+role+'_'+slot+'"]');
      const nameEl = podiumContainer.querySelector('[data-name="'+role+'_'+slot+'"]');
      const pctEl = podiumContainer.querySelector('[data-pct="'+role+'_'+slot+'"]');
      if(!nameEl || !pctEl) return;
      if(!cand){ if(avatarEl) avatarEl.innerHTML=''; nameEl.textContent='‚Äî'; pctEl.textContent='0%'; return; }
      const url = (cand.photo && cand.photo.length>10) ? cand.photo : childAvatarDataUrl(cand.name || cand.id);
      if(avatarEl) avatarEl.innerHTML = '<img src="'+url+'" alt="avatar">';
      nameEl.textContent = cand.name || '‚Äî';
      const pct = total? Math.round((cand.votes||0)/total*100) : 0; pctEl.textContent = pct + '%';
    };
    set(1, top1); set(2, top2); set(3, top3);
  }

  // realtime listeners
  let unsubCandidates=null, unsubVoters=null, unsubVotes=null;
  function startRealtimeListeners(){
    if(unsubCandidates) unsubCandidates(); if(unsubVoters) unsubVoters(); if(unsubVotes) unsubVotes();

    // build podiumContainer html (once)
    podiumContainer.innerHTML = '';
    ROLES.forEach(r=>{ podiumContainer.insertAdjacentHTML('beforeend', makePodiumHtmlForRole(r)); });

    unsubCandidates = db.collection('candidates').onSnapshot(snap=>{
      // populate dropdown
      candidatesDropdown.innerHTML = '';
      const allCands = [];
      snap.forEach(d=>{ const c = Object.assign({ id:d.id }, d.data()); allCands.push(c); const opt = document.createElement('option'); opt.value = c.id; opt.textContent = (c.emoji? c.emoji+' ':'') + (c.name||'‚Äî') + ' ('+(ROLE_LABEL[c.role]||c.role)+')'; candidatesDropdown.appendChild(opt); });
      statCandidates.textContent = snap.size;
      // update podium per role
      ROLES.forEach(role=>{
        const filtered = allCands.filter(x=> (x.role||'pres') === role);
        updatePodiumForRole(role, filtered);
      });
    });

    unsubVoters = db.collection('voters').onSnapshot(snap=>{
      votersDropdown.innerHTML = '';
      snap.forEach(d=>{ const v = Object.assign({ id:d.id }, d.data()); const opt = document.createElement('option'); opt.value = v.id; opt.textContent = (v.emoji? v.emoji+' ':'') + (v.name||'‚Äî'); votersDropdown.appendChild(opt); });
      statVoters.textContent = snap.size;
    });

    unsubVotes = db.collection('votes').onSnapshot(snap=>{ statVotes.textContent = snap.size; });
  }

  lockAdmin();
  window.__admin_db = db; // debug
});
</script>
</body>
</html>
